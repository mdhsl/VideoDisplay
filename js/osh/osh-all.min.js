var Hashtable=function(UNDEFINED){var FUNCTION="function",STRING="string",UNDEF="undefined";if(typeof encodeURIComponent==UNDEF||Array.prototype.splice===UNDEFINED||Object.prototype.hasOwnProperty===UNDEFINED){return null}function toStr(obj){return typeof obj==STRING?obj:""+obj}function hashObject(obj){var hashCode;if(typeof obj==STRING){return obj}else if(typeof obj.hashCode==FUNCTION){hashCode=obj.hashCode();return typeof hashCode==STRING?hashCode:hashObject(hashCode)}else{return toStr(obj)}}function merge(o1,o2){for(var i in o2){if(o2.hasOwnProperty(i)){o1[i]=o2[i]}}}function equals_fixedValueHasEquals(fixedValue,variableValue){return fixedValue.equals(variableValue)}function equals_fixedValueNoEquals(fixedValue,variableValue){return typeof variableValue.equals==FUNCTION?variableValue.equals(fixedValue):fixedValue===variableValue}function createKeyValCheck(kvStr){return function(kv){if(kv===null){throw new Error("null is not a valid "+kvStr)}else if(kv===UNDEFINED){throw new Error(kvStr+" must not be undefined")}}}var checkKey=createKeyValCheck("key"),checkValue=createKeyValCheck("value");function Bucket(hash,firstKey,firstValue,equalityFunction){this[0]=hash;this.entries=[];this.addEntry(firstKey,firstValue);if(equalityFunction!==null){this.getEqualityFunction=function(){return equalityFunction}}}var EXISTENCE=0,ENTRY=1,ENTRY_INDEX_AND_VALUE=2;function createBucketSearcher(mode){return function(key){var i=this.entries.length,entry,equals=this.getEqualityFunction(key);while(i--){entry=this.entries[i];if(equals(key,entry[0])){switch(mode){case EXISTENCE:return true;case ENTRY:return entry;case ENTRY_INDEX_AND_VALUE:return[i,entry[1]]}}}return false}}function createBucketLister(entryProperty){return function(aggregatedArr){var startIndex=aggregatedArr.length;for(var i=0,entries=this.entries,len=entries.length;i<len;++i){aggregatedArr[startIndex+i]=entries[i][entryProperty]}}}Bucket.prototype={getEqualityFunction:function(searchValue){return typeof searchValue.equals==FUNCTION?equals_fixedValueHasEquals:equals_fixedValueNoEquals},getEntryForKey:createBucketSearcher(ENTRY),getEntryAndIndexForKey:createBucketSearcher(ENTRY_INDEX_AND_VALUE),removeEntryForKey:function(key){var result=this.getEntryAndIndexForKey(key);if(result){this.entries.splice(result[0],1);return result[1]}return null},addEntry:function(key,value){this.entries.push([key,value])},keys:createBucketLister(0),values:createBucketLister(1),getEntries:function(destEntries){var startIndex=destEntries.length;for(var i=0,entries=this.entries,len=entries.length;i<len;++i){destEntries[startIndex+i]=entries[i].slice(0)}},containsKey:createBucketSearcher(EXISTENCE),containsValue:function(value){var entries=this.entries,i=entries.length;while(i--){if(value===entries[i][1]){return true}}return false}};function searchBuckets(buckets,hash){var i=buckets.length,bucket;while(i--){bucket=buckets[i];if(hash===bucket[0]){return i}}return null}function getBucketForHash(bucketsByHash,hash){var bucket=bucketsByHash[hash];return bucket&&bucket instanceof Bucket?bucket:null}function Hashtable(){var buckets=[];var bucketsByHash={};var properties={replaceDuplicateKey:true,hashCode:hashObject,equals:null};var arg0=arguments[0],arg1=arguments[1];if(arg1!==UNDEFINED){properties.hashCode=arg0;properties.equals=arg1}else if(arg0!==UNDEFINED){merge(properties,arg0)}var hashCode=properties.hashCode,equals=properties.equals;this.properties=properties;this.put=function(key,value){checkKey(key);checkValue(value);var hash=hashCode(key),bucket,bucketEntry,oldValue=null;bucket=getBucketForHash(bucketsByHash,hash);if(bucket){bucketEntry=bucket.getEntryForKey(key);if(bucketEntry){if(properties.replaceDuplicateKey){bucketEntry[0]=key}oldValue=bucketEntry[1];bucketEntry[1]=value}else{bucket.addEntry(key,value)}}else{bucket=new Bucket(hash,key,value,equals);buckets.push(bucket);bucketsByHash[hash]=bucket}return oldValue};this.get=function(key){checkKey(key);var hash=hashCode(key);var bucket=getBucketForHash(bucketsByHash,hash);if(bucket){var bucketEntry=bucket.getEntryForKey(key);if(bucketEntry){return bucketEntry[1]}}return null};this.containsKey=function(key){checkKey(key);var bucketKey=hashCode(key);var bucket=getBucketForHash(bucketsByHash,bucketKey);return bucket?bucket.containsKey(key):false};this.containsValue=function(value){checkValue(value);var i=buckets.length;while(i--){if(buckets[i].containsValue(value)){return true}}return false};this.clear=function(){buckets.length=0;bucketsByHash={}};this.isEmpty=function(){return!buckets.length};var createBucketAggregator=function(bucketFuncName){return function(){var aggregated=[],i=buckets.length;while(i--){buckets[i][bucketFuncName](aggregated)}return aggregated}};this.keys=createBucketAggregator("keys");this.values=createBucketAggregator("values");this.entries=createBucketAggregator("getEntries");this.remove=function(key){checkKey(key);var hash=hashCode(key),bucketIndex,oldValue=null;var bucket=getBucketForHash(bucketsByHash,hash);if(bucket){oldValue=bucket.removeEntryForKey(key);if(oldValue!==null){if(bucket.entries.length==0){bucketIndex=searchBuckets(buckets,hash);buckets.splice(bucketIndex,1);delete bucketsByHash[hash]}}}return oldValue};this.size=function(){var total=0,i=buckets.length;while(i--){total+=buckets[i].entries.length}return total}}Hashtable.prototype={each:function(callback){var entries=this.entries(),i=entries.length,entry;while(i--){entry=entries[i];callback(entry[0],entry[1])}},equals:function(hashtable){var keys,key,val,count=this.size();if(count==hashtable.size()){keys=this.keys();while(count--){key=keys[count];val=hashtable.get(key);if(val===null||val!==this.get(key)){return false}}return true}return false},putAll:function(hashtable,conflictCallback){var entries=hashtable.entries();var entry,key,value,thisValue,i=entries.length;var hasConflictCallback=typeof conflictCallback==FUNCTION;while(i--){entry=entries[i];key=entry[0];value=entry[1];if(hasConflictCallback&&(thisValue=this.get(key))){value=conflictCallback(key,thisValue,value)}this.put(key,value)}},clone:function(){var clone=new Hashtable(this.properties);clone.putAll(this);return clone}};Hashtable.prototype.toQueryString=function(){var entries=this.entries(),i=entries.length,entry;var parts=[];while(i--){entry=entries[i];parts[i]=encodeURIComponent(toStr(entry[0]))+"="+encodeURIComponent(toStr(entry[1]))}return parts.join("&")};return Hashtable}();var OSH={version:"dev"};function expose(){var oldOSH=window.OSH;OSH.noConflict=function(){window.OSH=oldOSH;return this};window.OSH=OSH}var instance=null;var STATE={NONE:0,BUFFERING:1,READY:2};var Buffer=function(){this.startCurrentTime=null;this.startDataTime=(new Date).getTime();this.endDataTime=null;this.replayFactor=null;this.buffer=new Array;this.clientTable=new Hashtable;this.observers=new Array;this.bufferState=0;this.bufferDelay=0;this.synchronized=true};Buffer.getBufferSingleton=function(){if(instance==null){instance=new Buffer}return instance};Buffer.prototype.setDelay=function(delay){this.bufferDelay=delay};Buffer.prototype.setSynchronized=function(synchronize){this.synchronized=synchronize};Buffer.prototype.setReplayFactor=function(replayFactor){if(replayFactor<=0){this.replayFactor=1}this.replayFactor=replayFactor};Buffer.prototype.addObserver=function(observerCB){this.observers.push(observerCB)};Buffer.prototype.push=function(id,data,timeStamp,name){var datum={id:id,data:data,timeStamp:timeStamp};this.buffer.push(datum);this.callbackObservers(id,name,timeStamp,data);if(this.startDataTime>datum.timeStamp){this.startDataTime=datum.timeStamp}if(this.bufferState==STATE.NONE){this.bufferState=STATE.BUFFERING;this.start()}if(this.bufferState==STATE.READY){if(this.synchronized){this.buffer.sort(function(a,b){if(a.timeStamp>b.timeStamp){return 1}if(a.timeStamp<b.timeStamp){return-1}return 0})}if(this.buffer.length==1){this.processNextData()}}};Buffer.prototype.processNextData=function(){var currentEllapsedTime=(new Date).getTime()-this.startCurrentTime;if(this.buffer.length>0){var next=this.buffer[0];var waitTime=-1;if(this.synchronized){waitTime=(next.timeStamp-this.startDataTime)/this.replayFactor-currentEllapsedTime}if(waitTime>0){window.setTimeout(function(){this.callbackData()}.bind(this),waitTime)}else{this.callbackData()}}};Buffer.prototype.callbackData=function(){var next=this.buffer.shift();if(typeof next!="undefined"&&!isNaN(next.timeStamp)){this.clientTable.get(next.id)(next.data)}this.processNextData()};Buffer.prototype.callbackObservers=function(id,name,timeStamp,data){if(this.observers.length>0){for(var i=0;i<this.observers.length;i++){var callback=this.observers[i];callback({percent:0,name:name,id:id,timeStamp:timeStamp,received:(new Date).getTime()})}}};Buffer.prototype.register=function(id,callback){this.clientTable.put(id,callback)};Buffer.prototype.start=function(){window.setTimeout(function(){this.bufferState=STATE.READY;this.startCurrentTime=(new Date).getTime();this.processNextData()}.bind(this),this.bufferDelay)};Buffer.prototype.reset=function(){this.bufferDelay=0;this.startCurrentTime=(new Date).getTime();this.bufferState=STATE.NONE;this.buffer=new Array};OSH.Utils={version:"dev"};window.OSH.Utils=OSH.Utils;OSH.Utils=function(){};OSH.Utils.randomUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16)})};OSH.Utils.getStyleRuleValue=function(style,selector,sheet){var sheets=typeof sheet!=="undefined"?[sheet]:document.styleSheets;for(var i=0,l=sheets.length;i<l;i++){var sheet=sheets[i];if(!sheet.cssRules){continue}for(var j=0,k=sheet.cssRules.length;j<k;j++){var rule=sheet.cssRules[j];if(rule.selectorText&&rule.selectorText.split(",").indexOf(selector)!==-1){return rule.style[style]}}}return null};var instanceController=null;OSH.Controller=function(){this.buffer=Buffer.getBufferSingleton();this.tableEvents=new Hashtable};OSH.Controller.getSingleton=function(){if(instanceController==null){instanceController=new OSH.Controller}return instanceController};OSH.Controller.prototype.setOptions=function(params){if(params.startTime){this.buffer.setStartDate(params.startTime)}if(params.endTime){this.buffer.setEndDate(params.endTime)}if(params.replayFactor){this.buffer.setReplayFactor(params.replayFactor)}if(params.bufferingTime){this.buffer.setDelay(params.bufferingTime)}if(params.synchronizedTime!="undefined"){this.buffer.setSynchronized(params.synchronizedTime)}};OSH.Controller.prototype.addDataSource=function(url,name,timeStampParser,callback){var uuid=OSH.Utils.randomUUID();var ws=new WebSocket(url);ws.binaryType="arraybuffer";ws.onmessage=function(event){if(event.data.byteLength>0){var timeStamp=(new Date).getTime();if(timeStampParser!=null){timeStamp=timeStampParser(event.data)}this.buffer.push(uuid,event.data,timeStamp,name)}}.bind(this);ws.onerror=function(event){ws.close()};this.buffer.register(uuid,callback);return uuid};OSH.Controller.prototype.addDataSourceObserver=function(observer){this.buffer.addObserver(observer)};OSH.TimeStampParser={version:"dev"};window.OSH.TimeStampParser=OSH.TimeStampParser;var UTCAndroidShiftTime=16*1e3;OSH.TimeStampParser=function(){};OSH.TimeStampParser.parseAndroidText=function(data){var rec=String.fromCharCode.apply(null,new Uint8Array(data));var tokens=rec.trim().split(",");var date=new Date(tokens[0]);return date.getTime()-UTCAndroidShiftTime};OSH.TimeStampParser.parseMpegVideo=function(data){return new DataView(data).getFloat64(0,false)*1e3};OSH.TimeStampParser.VideoMP4=function(){this.absoluteTime=-1};OSH.TimeStampParser.VideoMP4.prototype.parse=function(data){if(this.absoluteTime==-1){var infos=readMP4Info(data);console.log("PTS : "+infos.pts);console.log("timeScale : "+infos.timeScale);console.log("duration : "+infos.duration);console.log("rate : "+infos.rate);this.absoluteTime=infos.absoluteTime;this.timeScale=infos.timeScale;return this.absoluteTime}else{var infos=readMP4Info(data);console.log("PTS : "+infos.pts);console.log("timeScale : "+infos.timeScale);console.log("duration : "+infos.duration);console.log("rate : "+infos.rate);return infos.pts*1e3*this.timeScale+this.absoluteTime}};function readMP4Info(data){var infos={absoluteTime:0,pts:0,timeScale:0,duration:0,rate:0};var pos=60;infos.absoluteTime=new DataView(data,pos,pos+8).getUint32(0);infos.absoluteTime=(infos.absoluteTime-2082844800)*1e3;console.log(new Date(infos.absoluteTime).toISOString());pos+=8;infos.pts=new DataView(data,pos,pos+4).getUint32(0);pos+=4;infos.timeScale=new DataView(data,pos,pos+4).getUint32(0);infos.timeScale=1/infos.timeScale;pos+=4;infos.duration=new DataView(data,pos,pos+4).getUint32(0);pos+=4;infos.rate=new DataView(data,pos,pos+4).getUint32(0);return infos}OSH.Video={version:"dev"};window.OSH.Video=OSH.Video;OSH.Video=function(options){this.format="mp4";this.width="640px";this.height="480px";this.div="body";if(options.width){this.width=options.width}if(options.height){this.height=options.height}if(options.div){this.div=options.div}if(options.format&&options.format=="mjpeg"){this.format="mjpeg"}var css="";if(options.css){css=options.css}var id=OSH.Utils.randomUUID();if(options.id){id=options.id}var subParams={width:this.width,height:this.height,css:css,id:id};if(this.format=="mjpeg"){this.video=new OSH.Video.Mjpeg(document.getElementById(this.div),subParams)}else if(this.format=="mp4"){this.video=new OSH.Video.Mp4(document.getElementById(this.div),subParams);this.timeStampParser=new OSH.TimeStampParser.VideoMP4}};OSH.Video.prototype.parseTimeStamp=function(data){if(this.format=="mjpeg"){return OSH.TimeStampParser.parseMpegVideo(data)}else if(this.format=="mp4"){return this.timeStampParser.parse(data)}};OSH.Video.prototype.onDataCallback=function(data){this.video.onDataCallback(data)};OSH.Video.Mp4=function(div,options){this.video=document.createElement("video");this.video.setAttribute("height",options.height);this.video.setAttribute("width",options.width);this.video.setAttribute("class",options.css);if(options.id){this.video.setAttribute("id",options.id)}div.appendChild(this.video);this.mediaSource=new MediaSource;this.buffer=null;this.queue=[];this.video.src=window.URL.createObjectURL(this.mediaSource);this.mediaSource.addEventListener("sourceopen",function(e){this.mediaSource.duration=1e7;this.video.play();this.buffer=this.mediaSource.addSourceBuffer('video/mp4; codecs="avc1.64001E"');this.buffer.addEventListener("updatestart",function(e){});this.buffer.addEventListener("update",function(e){});this.buffer.addEventListener("updateend",function(e){});this.buffer.addEventListener("error",function(e){});this.buffer.addEventListener("abort",function(e){});this.buffer.addEventListener("update",function(){if(this.queue.length>0&&!this.buffer.updating){this.buffer.appendBuffer(this.queue.shift())}}.bind(this))}.bind(this),false);this.mediaSource.addEventListener("sourceopen",function(e){});this.mediaSource.addEventListener("sourceended",function(e){});this.mediaSource.addEventListener("sourceclose",function(e){});this.mediaSource.addEventListener("error",function(e){console.log("error: "+this.mediaSource.readyState)})};OSH.Video.Mp4.prototype.onDataCallback=function(data){if(this.buffer.updating||this.queue.length>0){this.queue.push(data)}else{this.buffer.appendBuffer(data)}};OSH.Video.Mjpeg=function(div,options){this.imgTag=document.createElement("img");this.imgTag.setAttribute("height",options.height);this.imgTag.setAttribute("width",options.width);this.imgTag.setAttribute("class",options.css);if(options.id){this.imgTag.setAttribute("id",options.id)}div.appendChild(this.imgTag)};OSH.Video.Mjpeg.prototype.onDataCallback=function(data){var imgBlob=new Blob([data]);var blobURL=window.URL.createObjectURL(imgBlob.slice(12));var oldBlobURL=this.imgTag.src;this.imgTag.src=blobURL;window.URL.revokeObjectURL(oldBlobURL)};OSH.UI={version:"dev"};window.OSH.UI=OSH.UI;OSH.UI.Dialog=function(options){var uniqueId=(new Date).getTime();this.div=document.createElement("div");this.div.setAttribute("class","pop-over");this.div.setAttribute("id",uniqueId);this.div.setAttribute("draggable","true");var closeButton=document.createElement("a");closeButton.setAttribute("class","pop-close");closeButton.innerHTML="x";closeButton.onclick=this.close.bind(this);this.div.appendChild(closeButton);var title="Title";var h3=document.createElement("h3");h3.innerHTML=title;if(options.title){h3.innerHTML=options.title}this.div.appendChild(h3);this.divContent=document.createElement("div");this.divContent.setAttribute("class","pop-content");this.div.appendChild(this.divContent);this.div.style.display="block";document.body.appendChild(this.div);this.div.addEventListener("dragstart",this.drag_start.bind(this),false);document.addEventListener("dragover",this.drag_over.bind(this),false);document.addEventListener("drop",this.drop.bind(this),false)};OSH.UI.Dialog.prototype.appendContent=function(div){this.divContent.style.width=div.style.width+"px";this.divContent.style.height=div.style.height+"px";this.divContent.appendChild(div)};OSH.UI.Dialog.prototype.setContentSize=function(width,height){this.divContent.style.width=width;this.divContent.style.height=height};OSH.UI.Dialog.prototype.onClose=function(callback){this.onClose=callback};OSH.UI.Dialog.prototype.close=function(){document.body.removeChild(this.div);if(this.onClose){this.onClose()}};OSH.UI.Dialog.prototype.drag_start=function(event){event.stopPropagation();var style=window.getComputedStyle(event.target,null);event.dataTransfer.effectAllowed="all";event.dataTransfer.setData("text-"+this.div.id,parseInt(style.getPropertyValue("left"),10)-event.clientX+","+(parseInt(style.getPropertyValue("top"),10)-event.clientY))};OSH.UI.Dialog.prototype.drag_over=function(event){event.stopPropagation();event.preventDefault();return false};OSH.UI.Dialog.prototype.drop=function(event){event.stopPropagation();var offset=event.dataTransfer.getData("text-"+this.div.id).split(",");this.div.style.left=(event.clientX+parseInt(offset[0],10))*100/window.innerWidth+"%";this.div.style.top=event.clientY+parseInt(offset[1],10)+"px";event.preventDefault();return false};